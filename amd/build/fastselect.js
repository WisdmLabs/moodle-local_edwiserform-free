"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t,e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e(require("jquery")):e((void 0).jQuery)}(0,function(t){var e=t(document),s=0,i=t.fastsearch,n=i.pickTo,l=i.selectorFromClass;function o(t,e){this.init.apply(this,arguments)}function a(t){this.init(t)}return t.extend(o.prototype,{init:function(e,i){this.$input=t(e),this.options=n(t.extend(!0,{},o.defaults,i,{placeholder:this.$input.attr("placeholder")}),this.$input.data(),["url","loadOnce","apiParam","initialValue","userOptionAllowed"]),this.ens=".fastselect"+ ++s,this.hasCustomLoader=this.$input.is("input"),this.isMultiple=!!this.$input.attr("multiple"),this.userOptionAllowed=this.hasCustomLoader&&this.isMultiple&&this.options.userOptionAllowed,this.optionsCollection=new a(n({multipleValues:this.isMultiple},this.options,["url","loadOnce","parseData","matcher"])),this.setupDomElements(),this.setupFastsearch(),this.setupEvents()},setupDomElements:function(){this.$el=t("<div>").addClass(this.options.elementClass),this[this.isMultiple?"setupMultipleElement":"setupSingleElement"](function(){this.updateDomElements(),this.$controls.appendTo(this.$el),this.$el.insertAfter(this.$input),this.$input.detach().appendTo(this.$el)})},setupSingleElement:function(e){var s=this.processInitialOptions(),i=s&&s.length?s[0].text:this.options.placeholder;this.$el.addClass(this.options.singleModeClass),this.$controls=t("<div>").addClass(this.options.controlsClass),this.$toggleBtn=t("<div>").addClass(this.options.toggleButtonClass).text(i).appendTo(this.$el),this.$queryInput=t("<input>").attr("placeholder",this.options.searchPlaceholder).addClass(this.options.queryInputClass).appendTo(this.$controls),e.call(this)},setupMultipleElement:function(e){var s=this,i=s.options,n=this.processInitialOptions();this.$el.addClass(i.multipleModeClass),this.$controls=t("<div>").addClass(i.controlsClass),this.$queryInput=t("<input>").addClass(i.queryInputClass).appendTo(this.$controls),n&&t.each(n,function(t,e){s.addChoiceItem(e)}),e.call(this)},updateDomElements:function(){this.$el.toggleClass(this.options.noneSelectedClass,!this.optionsCollection.hasSelectedValues()),this.adjustQueryInputLayout()},processInitialOptions:function(){var e,s=this;return this.hasCustomLoader?(e=this.options.initialValue,t.isPlainObject(e)&&(e=[e])):e=t.map(this.$input.find("option:selected").get(),function(e){var s=t(e);return{text:s.text(),value:s.attr("value")}}),e&&t.each(e,function(t,e){s.optionsCollection.setSelected(e)}),e},addChoiceItem:function(e){var s=["primary","warning","success","info"];t('<div data-text="'+e.text+'" data-value="'+e.value+'" class="'+this.options.choiceItemClass+" btn-"+s[Math.floor(Math.random()*s.length)]+'">'+t("<div>").html(e.text).text()+'<button class="'+this.options.choiceRemoveClass+'" type="button">Ã—</button></div>').insertBefore(this.$queryInput)},setupFastsearch:function(){var e=this,s=this.options,l={};n(l,s,["resultsContClass","resultsOpenedClass","resultsFlippedClass","groupClass","itemClass","focusFirstItem","groupTitleClass","loadingClass","noResultsClass","noResultsText","focusedItemClass","flipOnBottom"]),this.fastsearch=new i(this.$queryInput.get(0),t.extend(l,{wrapSelector:this.isMultiple?this.$el:this.$controls,minQueryLength:0,typeTimeout:this.hasCustomLoader?s.typeTimeout:0,preventSubmit:!0,fillInputId:!1,responseFormat:{label:"text",groupCaption:"label"},onItemSelect:function(t,i,n){var l=s.maxItems;e.isMultiple&&l&&e.optionsCollection.getValues().length>l-1?s.onMaxItemsReached&&s.onMaxItemsReached(this):(e.setSelectedOption(i),e.writeToInput(),!e.isMultiple&&e.hide(),s.clearQueryOnSelect&&n.clear(),e.userOptionAllowed&&i.isUserOption&&(n.$resultsCont.remove(),delete n.$resultsCont,e.hide()),s.onItemSelect&&s.onItemSelect.call(e,t,i,e,n))},onItemCreate:function(t,i){i.$item=t,i.selected&&t.addClass(s.itemSelectedClass),e.userOptionAllowed&&i.isUserOption&&t.text(e.options.userOptionPrefix+t.text()).addClass(e.options.userOptionClass),s.onItemCreate&&s.onItemCreate.call(e,t,i,e)}})),this.fastsearch.getResults=function(){e.userOptionAllowed&&e.$queryInput.val().length>1&&e.renderOptions(),e.getOptions(function(){e.renderOptions(!0)})}},getOptions:function(e){var s=this.options,i={};if(this.hasCustomLoader){var n=t.trim(this.$queryInput.val());n&&s.apiParam&&(i[s.apiParam]=n),this.optionsCollection.fetch(i,e)}else!this.optionsCollection.models&&this.optionsCollection.reset(this.gleanSelectData(this.$input)),e()},namespaceEvents:function(t){return i.prototype.namespaceEvents.call(this,t)},setupEvents:function(){var e=this,s=this.options;this.isMultiple?(this.$el.on(this.namespaceEvents("click"),function(i){t(i.target).is(l(s.controlsClass))&&e.$queryInput.focus()}),this.$queryInput.on(this.namespaceEvents("keyup"),function(t){e.adjustQueryInputLayout(),e.show()}).on(this.namespaceEvents("focusin"),function(){e.show(),e.$queryInput.attr("placeholder",s.searchPlaceholder)}).on(this.namespaceEvents("focusout"),function(){e.$queryInput.attr("placeholder",s.placeholder)}),this.$el.on(this.namespaceEvents("click"),l(s.choiceRemoveClass),function(i){var n=t(i.currentTarget).closest(l(s.choiceItemClass));e.removeSelectedOption({value:n.attr("data-value"),text:n.attr("data-text")},n)})):this.$el.on(this.namespaceEvents("click"),l(s.toggleButtonClass),function(){e.$el.hasClass(s.activeClass)?e.hide():e.show(!0)})},adjustQueryInputLayout:function(){if(this.isMultiple&&this.$queryInput){var e=this.$el.hasClass(this.options.noneSelectedClass);this.$queryInput.toggleClass(this.options.queryInputExpandedClass,e),this.$queryInput.attr({style:"",placeholder:this.options.placeholder}),e||(this.$fakeInput=this.$fakeInput||t("<span>").addClass(this.options.fakeInputClass),this.$fakeInput.text(this.$queryInput.val().replace(/\s/g,"&nbsp;")),this.$fakeInput.detach())}},show:function(t){this.$el.addClass(this.options.activeClass),t?this.$queryInput.focus():this.fastsearch.handleTyping(),this.documentCancelEvents("on")},hide:function(){this.$el.removeClass(this.options.activeClass),this.documentCancelEvents("off")},documentCancelEvents:function(t){i.prototype.documentCancelEvents.call(this,t,this.hide)},setSelectedOption:function(t){if(!this.optionsCollection.isSelected(t.value)){this.optionsCollection.setSelected(t);var e=this.optionsCollection.findWhere(function(e){return e.value===t.value});this.isMultiple?this.$controls&&this.addChoiceItem(t):(this.fastsearch&&this.fastsearch.$resultItems.removeClass(this.options.itemSelectedClass),this.$toggleBtn&&this.$toggleBtn.text(t.text)),e&&e.$item.addClass(this.options.itemSelectedClass),this.updateDomElements()}},removeSelectedOption:function(t,e){var s=this.optionsCollection.removeSelected(t);s&&s.$item&&s.$item.removeClass(this.options.itemSelectedClass),e?e.remove():this.$el.find(l(this.options.choiceItemClass)+'[data-value="'+t.value+'"]').remove(),this.updateDomElements(),this.writeToInput()},writeToInput:function(){var t=this.optionsCollection.getValues(),e=this.options.valueDelimiter,s=this.isMultiple?this.hasCustomLoader?t.join(e):t:t[0];this.$input.val(s).trigger("change")},renderOptions:function(t){var e,s=this.$queryInput.val();if(e=this.optionsCollection.models?(t?this.optionsCollection.filter(s):this.optionsCollection.models).slice(0):[],this.userOptionAllowed){var i=this.optionsCollection.models&&this.optionsCollection.findWhere(function(t){return t.value===s});s&&!i&&e.unshift({text:s,value:s,isUserOption:!0})}this.fastsearch.showResults(this.fastsearch.storeResponse(e).generateResults(e))},gleanSelectData:function(e){var s=this,i=e.children();return i.eq(0).is("optgroup")?t.map(i.get(),function(e){var i=t(e);return{label:i.attr("label"),items:s.gleanOptionsData(i.children())}}):this.gleanOptionsData(i)},gleanOptionsData:function(e){return t.map(e.get(),function(e){var s=t(e);return{text:s.text(),value:s.attr("value"),selected:s.is(":selected")}})},destroy:function(){e.off(this.ens),this.fastsearch.destroy(),this.$input.off(this.ens).detach().insertAfter(this.$el),this.$el.off(this.ens).remove(),this.$input.data()&&delete this.$input.data().fastselect}}),t.extend(a.prototype,{defaults:{loadOnce:!1,url:null,parseData:null,multipleValues:!1,matcher:function(t,e){return t.toLowerCase().indexOf(e.toLowerCase())>-1}},init:function(e){this.options=t.extend({},this.defaults,e),this.selectedValues={}},fetch:function(t,e){var s=this,i=function(){s.applySelectedValues(e)};this.options.loadOnce?(this.fetchDeferred=this.fetchDeferred||this.load(t),this.fetchDeferred.done(i)):this.load(t,i)},reset:function(t){this.models=this.options.parseData?this.options.parseData(t):t,this.applySelectedValues()},applySelectedValues:function(t){this.each(function(t){this.options.multipleValues&&t.selected?this.selectedValues[t.value]=!0:t.selected=!!this.selectedValues[t.value]}),t&&t.call(this)},load:function(e,s){var i=this,n=this.options;return t.get(n.url,e,function(t){i.models=n.parseData?n.parseData(t):t,s&&s.call(i)})},setSelected:function(t){this.options.multipleValues||(this.selectedValues={}),this.selectedValues[t.value]=!0,this.applySelectedValues()},removeSelected:function(t){var e=this.findWhere(function(e){return t.value===e.value});return e&&(e.selected=!1),delete this.selectedValues[t.value],e},isSelected:function(t){return!!this.selectedValues[t]},hasSelectedValues:function(){return this.getValues().length>0},each:function(e){var s=this;this.models&&t.each(this.models,function(i,n){n.items?t.each(n.items,function(t,i){e.call(s,i)}):e.call(s,n)})},where:function(t){var e=[];return this.each(function(s){t(s)&&e.push(s)}),e},findWhere:function(t){var e=this.where(t);return e.length?e[0]:void 0},filter:function(e){var s=this;function i(t){return s.options.matcher(t.text,e)?t:null}return e&&0!==e.length?t.map(this.models,function(e){if(e.items){var s=t.map(e.items,i);return s.length?{label:e.label,items:s}:null}return i(e)}):this.models},getValues:function(){return t.map(this.selectedValues,function(t,e){return t?e:null})}}),o.defaults={elementClass:"fstElement form-control",singleModeClass:"fstSingleMode",noneSelectedClass:"fstNoneSelected",multipleModeClass:"fstMultipleMode",queryInputClass:"fstQueryInput form-control",queryInputExpandedClass:"fstQueryInputExpanded",fakeInputClass:"fstFakeInput",controlsClass:"fstControls",toggleButtonClass:"fstToggleBtn",activeClass:"fstActive",itemSelectedClass:"btn-primary",choiceItemClass:"fstChoiceItem",choiceRemoveClass:"fstChoiceRemove",userOptionClass:"fstUserOption",resultsContClass:"fstResults",resultsOpenedClass:"fstResultsOpened",resultsFlippedClass:"fstResultsFilpped",groupClass:"fstGroup",itemClass:"fstResultItem",groupTitleClass:"fstGroupTitle",loadingClass:"fstLoading",noResultsClass:"fstNoResults",focusedItemClass:"fstFocused",matcher:null,url:null,loadOnce:!1,apiParam:"query",initialValue:null,clearQueryOnSelect:!0,minQueryLength:1,focusFirstItem:!1,flipOnBottom:!0,typeTimeout:150,userOptionAllowed:!1,valueDelimiter:",",maxItems:null,parseData:null,onItemSelect:null,onItemCreate:null,onMaxItemsReached:null,placeholder:M.util.get_string("lbl-event-choose","local_edwiserform"),searchPlaceholder:M.util.get_string("lbl-event-search","local_edwiserform"),noResultsText:M.util.get_string("lbl-event-search-not-found","local_edwiserform"),userOptionPrefix:"Add "},t.Fastselect=o,t.Fastselect.OptionsCollection=a,t.fn.fastselect=function(e){var s=null;return this.each(function(){t.data(this,"fastselect")?s=t.data(this,"fastselect"):(s=new o(this,e),void 0!==e&&e.hasOwnProperty("callbacks")&&Object.keys(e.callbacks).forEach(function(t){s[t]=e.callbacks[t]}),t.data(this,"fastselect",s))}),s},t});