"use strict";define(["jquery","core/ajax","core/notification","core/templates","local_edwiserform/form_styles","local_edwiserform/efb_form_basic_settings","local_edwiserform/formbuilder","local_edwiserform/fastsearch","local_edwiserform/fastselect"],function(e,t,o,i,n){var s,r,a,l={FORMTYPE:"#id_type",COMPONENT:"local_edwiserform",EVENT:"#id_events",EVENT_LIST:".efb-event-list",FORM_STYLE:".efb-form-style",RENDER_FORM:".render-form",PANEL:".efb-panel-btn",TEMPLATE_OVERLAY:".efb-forms-template-overlay",TITLE:"#id_title",ACTIVE:"active",FORM_TITLE:"#efb-form-title"},f=document.querySelector(".build-form"),c=document.querySelector(l.RENDER_FORM),d=!1,m=null,u={container:f,svgSprite:M.cfg.wwwroot+"/local/edwiserform/pix/formeo-sprite.svg",localStorage:!1},g={GET_TEMPLATE:function(e){return t.call([{methodname:"edwiserform_get_template",args:{name:e}}])[0]},GET_EVENT_SETTINGS:function(e,o){return t.call([{methodname:"edwiserform_get_event_settings",args:{event:e,id:o}}])[0]},CREATE_NEW_FORM:function(e,o){return t.call([{methodname:"edwiserform_create_new_form",args:{setting:e,formdef:o.toString()}}])[0]},UPDATE_FORM:function(e,o){return t.call([{methodname:"edwiserform_update_form_settings",args:{setting:e,formdef:o.toString()}}])[0]}};function p(){var t=v()&&E(!1)&&!b();return e("#efb-btn-save-form-settings").parents(".efb-editor-button").toggleClass("d-none",!t),e(".efb-form-save").toggleClass("d-none",!t),t}function v(){return e(".efb-forms-template.active").length>0}function h(t){e(l.PANEL).removeClass(l.ACTIVE),e("#efb-".concat(t)).addClass(l.ACTIVE),e(".efb-tabcontent").removeClass(l.ACTIVE),e("#efb-cont-".concat(t)).addClass(l.ACTIVE)}function E(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];settings=r();var o=e(".efb-panel-btn.active").attr("id"),i=""!=settings.title;if(!t)return i;if(i)e(".efb-form-title-container").removeClass("has-danger"),e(l.TITLE).parents(".fitem").removeClass("has-danger");else{switch(o){case"efb-form-setup":case"efb-form-builder":case"efb-form-preview":h("form-settings");case"efb-form-settings":e(l.TITLE).parents(".fitem").addClass("has-danger")}a.dom.toaster(M.util.get_string("lbl-title-warning",l.COMPONENT),3e3)}return i}u.resetForm=function(){a.dom.loading();var t=e(l.FORMTYPE).val();g.GET_TEMPLATE(t).done(function(e){if(a.dom.loadingClose(),1==e.status)return u.container=f,void(a=new Formeo(u,e.definition))}).fail(function(e){a.dom.loadingClose(),o.exception(e)})},u.get_pro_demo_url=function(e){return videotypes.hasOwnProperty(e)?videotypes[e]:videotypes.default},r=function(){var t=e(l.FORMTYPE).val();return{title:e("#id_title").val(),description:e("#id_description").val(),type:t,notifi_email:e("#id_notifi_email").val(),message:e("#id_confirmation_msg").val(),draftitemid:e('[name="confirmation_msg[itemid]"]').val(),data_edit:e("#id_editdata").prop("checked")}},s=function(){return a.formData};var _={removeSelectedOption:function(t,o){if(t.value!=e(l.FORMTYPE).val()){var i=this.optionsCollection.removeSelected(t);i&&i.$item&&i.$item.removeClass(this.options.itemSelectedClass),o?o.remove():this.$el.find(selectorFromClass(this.options.choiceItemClass)+'[data-value="'+t.value+'"]').remove(),this.updateDomElements(),this.writeToInput(),"enrolment"==t.value&&e("#efb-event-enrolment").remove()}else a.dom.toaster(M.util.get_string("cannot-remove-event",l.COMPONENT,e(l.FORMTYPE).find("option:selected").html()),3e3)},setSelectedOption:function(t){if(!this.optionsCollection.isSelected(t.value)){this.optionsCollection.setSelected(t);var o=this.optionsCollection.findWhere(function(e){return e.value===t.value});if(this.isMultiple?this.$controls&&this.addChoiceItem(t):(this.fastsearch&&this.fastsearch.$resultItems.removeClass(this.options.itemSelectedClass),this.$toggleBtn&&this.$toggleBtn.text(t.text)),o&&o.$item.addClass(this.options.itemSelectedClass),this.updateDomElements(),"enrolment"==t.value){Formeo.dom.loading();var n=Array.from(Array(10).keys());n.push("..."),i.render("local_edwiserform/event_settings_container",{name:t.text,courses:n}).done(function(t,o){i.appendNodeContents(e(l.EVENT_LIST),t,o),Formeo.dom.loadingClose()})}}}};function b(){return formdef=JSON.parse(s()),0==Object.keys(formdef.fields).length}function T(e,t,o,i){("create"==e?g.CREATE_NEW_FORM(t,o):g.UPDATE_FORM(t,o)).done(i).fail(function(e){a.dom.alert("danger",e.message)})}function C(t){e(".efb-form-title").text(t),e(".efb-editor-action").toggleClass("efb-hide",t.length<0),t.length<0?e("#id_error_template_title").show():e("#id_error_template_title").hide()}function O(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e(l.FORMTYPE).val(t);var i=new CustomEvent("change",{target:e(l.FORMTYPE)[0]});e(l.FORMTYPE)[0].dispatchEvent(i),u.container=f,a=new Formeo(u,o),e("#efb-form-settings").trigger("click")}function w(t){e(l.FORM_STYLE).removeClass("selected"),e(l.FORM_STYLE+'[data-form="'+t+'"]').addClass("selected");for(var o=1;o<=supportedStyles;o++)e(l.RENDER_FORM).hasClass("form-style-"+o)&&n.apply(e(l.RENDER_FORM),"remove",o);n.apply(e(l.RENDER_FORM),"add",t)}function N(){null==m&&(m=e(l.EVENT).hide().fastselect({callbacks:_})),e("#efb-settings-events").append('<div class="efb-event-list"></div>'),e(".efb-form-style-container .controls-toggle").click(function(){e(this).parents(".preview-form").toggleClass("show-styles"),e("#efb-cont-form-builder .formeo-controls").closest(".build-form").toggleClass("hidden-controls")}),e(l.FORM_STYLE).mouseenter(function(){e(".form-style-preview").attr("src",e(this).find("img").attr("src")).css("top",e(this).offset().top).show()}).mouseleave(l.FORM_STYLE,function(){e(".form-style-preview").attr("src","").hide()}).click(l.FORM_STYLE,function(t){w(e(this).data("form"))});var t=e("#id_allowsubmissionsfromdate_enabled").parent(),o=e(t).parent();t.detach().prependTo(o),t=e("#id_allowsubmissionstodate_enabled").parent(),o=e(t).parent(),t.detach().prependTo(o),e(".efb-settings-tab-list-item").click(function(){e(".efb-settings-tab-list-item").removeClass(l.ACTIVE),e(this).addClass(l.ACTIVE),e(".efb-settings-tab").removeClass(l.ACTIVE),e("#".concat(e(this).data("target"))).addClass(l.ACTIVE)}),e(document).on("formeoUpdated",function(e){p()}),e(document).on("controlsCollapsed",function(t){e(".efb-form-step-preview").toggleClass("collapsed",t.detail.collapsed)}),e(".efb-form-step").click(function(t){t.preventDefault();var o=e(this).data("id");e("#"+o).click()}),e(".efb-panel-btn").click(function(t){if(!v())return a.dom.toaster(M.util.get_string("select-template-warning",l.COMPONENT),3e3),h("form-setup"),void t.preventDefault();var o=e(this).attr("id");if("efb-form-setup"!=o&&"efb-form-settings"!=o&&!E())return 0;p();var i=e(this).data("panel");e("#efb-form-settings, #efb-form-builder, #efb-form-preview, #efb-form-setup").removeClass("active"),e("#efb-cont-form-settings, #efb-cont-form-builder, #efb-cont-form-preview, #efb-cont-form-setup").removeClass("active"),e(i).addClass("active"),e(this).addClass("active"),e(".efb-forms-panel-heading").text(e(this).data("panel-lbl")),"#efb-cont-form-preview"==i&&(a.render(c),w(1))}),e("body").on("click","#efb-btn-save-form-settings",function(t){if(!v())return a.dom.toaster(M.util.get_string("select-template-warning",l.COMPONENT),3e3),h("form-setup"),void t.preventDefault();if(!E()||!a.validator.validate())return 0;var o=r(),i=s(),n=e("[name='id']").val(),f="create",c=function(t){1==t.status?(d=!0,window.onbeforeunload=null,a.dom.alert("success",t.msg,function(){a.reset(),e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}),setTimeout(function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")},4e3)):a.dom.alert("danger",t.msg)};if(n){var m=function(t){1==t.status?(window.onbeforeunload=null,a.dom.multiActions("success",M.util.get_string("success",l.COMPONENT),t.msg,[{title:M.util.get_string("heading-listforms",l.COMPONENT),type:"primary",action:function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}},{title:M.util.get_string("close",l.COMPONENT),type:"default"}])):a.dom.alert("danger",t.msg)};a.dom.multiActions("warning",M.util.get_string("attention",l.COMPONENT),M.util.get_string("forms-update-confirm",l.COMPONENT),[{title:M.util.get_string("forms-update-create-new",l.COMPONENT),type:"primary",action:function(){T(f,o,i,c)}},{title:M.util.get_string("forms-update-overwrite-existing",l.COMPONENT),type:"warning",action:function(){f="update",o.id=n,T(f,o,i,m)}}])}else d?a.dom.toaster(M.util.get_string("form-setting-saved",l.COMPONENT),3e3):T(f,o,i,c)}),e(l.FORM_TITLE).keyup(function(){var t=e(this).val(),o=""==t;e(this).parent().toggleClass("has-danger",o),e("#id_title").val(t),C(t)}).change(function(){p()}),e("#id_title").keyup(function(){var t=e(this).val();e("#id_title").val(t),C(t)}).change(function(){var t=e(this).val();e(l.FORM_TITLE).val(t),p()}),e(l.FORMTYPE).change(function(){e(".efb-forms-template").removeClass("active");var t=e(this).val();e("#efb-forms-template-"+t).addClass("active"),e("#id_registration-enabled").prop("checked",!0)}),e(".efb-forms-template.pro").click(function(){a.dom.proWarning({type:e(this).find(".efb-forms-template-name").text(),video:e(this).data("template"),message:e(this).find(".efb-forms-template-details .desc").text()})}),e(".efb-forms-template-select").click(function(t){var o=this;p();var i=function(){var t=e(o).data("template");e(o).parents(l.TEMPLATE_OVERLAY).addClass("loading"),g.GET_TEMPLATE(t).done(function(i){e(o).parents(l.TEMPLATE_OVERLAY).removeClass("loading"),1!=i.status?a.dom.alert("warning",i.msg,function(){O(t,i.definition)}):O(t,i.definition)}).fail(function(t){e(o).parents(l.TEMPLATE_OVERLAY).removeClass("loading"),a.dom.alert("danger",t.message)})};e(".efb-forms-template.active").length&&!b()?a.dom.multiActions("warning",M.util.get_string("attention",l.COMPONENT),M.util.get_string("template-change-warning",l.COMPONENT),[{title:M.util.get_string("proceed",l.COMPONENT),type:"warning",action:i},{title:M.util.get_string("cancel",l.COMPONENT),type:"success"}]):i()}),e("body").on("click",".efb-event-label",function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;""!=e(this).next().html()&&function(t,o){if(e(t).parent(".efb-event").hasClass("collapsed")){o||e(".efb-event:not(.collapsed) h4").each(function(t,o){e(o).trigger("click",[!0])}),e(t).parent(".efb-event").removeClass("collapsed"),e(t).next().height("auto");var i=e(t).next()[0].clientHeight+"px";e(t).next().height("0px"),setTimeout(function(){e(t).next().height(i)},0)}else e(t).next().height("0px"),e(t).next()[0].addEventListener("transitionend",function(){e(t).parent(".efb-event").addClass("collapsed")},{once:!0})}(this,o)}),e("body").on("click",".efb-email-tag",function(){var t=e("<input>");e("body").append(t);var o=e(this).text();t.val(o).select(),document.execCommand("copy"),t.remove(),a.dom.toaster(M.util.get_string("shortcodecoppied",l.COMPONENT,o),3e3)}),p()}return{init:function(t,o){u.sitekey=t,u.prourl=o,e(document).ready(function(t){"undefined"!=typeof formdefinition?a=new Formeo(u,formdefinition):(u.localStorage=!0,a=new Formeo(u)),N(),e("#id_type").closest(".fitem").hide(),e("#root-page-loading").hide(),e(".efb-form-builder-wrap").show()})}}});