define(["jquery","core/ajax","local_edwiserform/efb_form_basic_settings","local_edwiserform/formbuilder"],function(e,t){return{init:function(i){e(document).ready(function(n){function o(){var t=g()&&p(!1)&&!v();e("#efb-btn-save-form-settings").parents(".efb-editor-button").toggleClass("d-none",!t),e(".efb-form-save").toggleClass("d-none",!t)}let r=document.querySelector(".build-form"),a=document.querySelector(".render-form"),s=!1;var f,l,c,d=[];let m={container:r,sitekey:i,prourl:"https://edwiser.org/edwiser-forms-pricing/",svgSprite:M.cfg.wwwroot+"/local/edwiserform/pix/formeo-sprite.svg",localStorage:!1};function g(){return e(".efb-forms-template.active").length>0}function u(t){e(".efb-panel-btn").removeClass("panel-active"),e(`#efb-${t}`).addClass("panel-active"),e(".efb-tabcontent").removeClass("content-active").addClass("content-hide"),e(`#efb-cont-${t}`).addClass("content-active").removeClass("content-hide")}function p(t=!0){settings=l();var i=e(".efb-panel-btn.panel-active").attr("id"),n=""!=settings.title;if(!t)return n;if(n)e(".efb-form-title-container").removeClass("has-danger"),e("#id_title").parents(".fitem").removeClass("has-danger");else{switch(i){case"efb-form-setup":case"efb-form-builder":case"efb-form-preview":u("form-settings");case"efb-form-settings":e("#id_title").parents(".fitem").addClass("has-danger")}c.dom.toaster(M.util.get_string("efb-lbl-title-warning","local_edwiserform"),3e3)}return n}function v(){return formdef=JSON.parse(f()),0==Object.keys(formdef.fields).length}function b(e,i,n,o){t.call([{methodname:e,args:{setting:i,formdef:n.toString()}}])[0].done(o).fail(function(e){c.dom.alert("danger",e.message)})}function _(t){e(".efb-form-title").text(t),e(".efb-editor-action").toggleClass("efb-hide",t.length<0),t.length<0?e("#id_error_template_title").show():e("#id_error_template_title").hide()}function w(t,i=""){e("#id_type").val(t);var n=new CustomEvent("change",{target:e("#id_type")[0]});e("#id_type")[0].dispatchEvent(n),m.container=r,c=new Formeo(m,i),e("#efb-form-settings").trigger("click")}"undefined"!=typeof formdefinition?c=new Formeo(m,formdefinition):(m.localStorage=!0,c=new Formeo(m)),e(".step-navigation #previous-step").click(function(){}),e(".step-navigation #next-step").click(function(){}),e(document).on("formeoUpdated",function(e){o()}),e(document).on("controlsCollapsed",function(t){e(".efb-form-step-preview").toggleClass("collapsed",t.detail.collapsed)}),e("#id_type").closest(".fitem").hide(),e(".efb-form-step").click(function(t){t.preventDefault();var i=e(this).data("id");e("#"+i).click()}),e(".efb-panel-btn").click(function(t){if(!g())return c.dom.toaster(M.util.get_string("efb-select-template-warning","local_edwiserform"),3e3),u("form-setup"),void t.preventDefault();var i=e(this).attr("id");if("efb-form-setup"!=i&&"efb-form-settings"!=i&&!p())return 0;o();var n=e(this).data("panel");e("#efb-form-settings, #efb-form-builder, #efb-form-preview, #efb-form-setup").removeClass("panel-active"),e("#efb-cont-form-settings, #efb-cont-form-builder, #efb-cont-form-preview, #efb-cont-form-setup").removeClass("content-active").addClass("content-hide"),e(n).addClass("content-active"),e(n).removeClass("content-hide"),e(this).addClass("panel-active"),e(".efb-forms-panel-heading").text(e(this).data("panel-lbl")),"#efb-cont-form-settings"==n&&e("#efb-btn-next").removeClass("efb-hide"),"#efb-cont-form-builder"==n&&(c.render(a),e("#efb-btn-previous, #efb-btn-next").removeClass("efb-hide")),"#efb-cont-form-preview"==n&&(c.render(a),e("#efb-btn-next").addClass("efb-hide"))}),l=function(){var t=e("#id_type").val(),i={title:e("#id_title").val(),description:e("#id_description").val(),type:t,notifi_email:e("#id_notifi_email").val(),message:e("#id_confirmation_msg").val(),draftitemid:e('[name="confirmation_msg[itemid]"]').val(),data_edit:e("#id_editdata").prop("checked"),eventsettings:""},n=[];return e.each(d,function(e,t){if(t.is_enabled()){var i=t.get_event_name(),o=t.get_settings();n[i]=o}}),i.eventsettings=JSON.stringify(n),i},f=function(){return c.formData},e("body").on("click","#efb-btn-save-form-settings",function(t){if(!g())return c.dom.toaster(M.util.get_string("efb-select-template-warning","local_edwiserform"),3e3),u("form-setup"),void t.preventDefault();if(!p())return 0;var i=l(),n=f(),o=e("[name='id']").val(),r="edwiserform_create_new_form",a=function(t){1==t.status?(s=!0,window.onbeforeunload=null,c.dom.alert("success",t.msg,function(){c.reset(),e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}),setTimeout(function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")},4e3)):c.dom.alert("danger",t.msg)};if(o){var d=function(t){1==t.status?(window.onbeforeunload=null,c.dom.alert("success",t.msg,function(){c.reset(),e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")})):c.dom.alert("danger",t.msg)};c.dom.multiActions("warning",M.util.get_string("attention","local_edwiserform"),M.util.get_string("efb-forms-update-confirm","local_edwiserform"),[{title:M.util.get_string("efb-forms-update-create-new","local_edwiserform"),type:"primary",action:function(){b(r,i,n,a)}},{title:M.util.get_string("efb-forms-update-overwrite-existing","local_edwiserform"),type:"success",action:function(){r="edwiserform_update_form_settings",i.id=o,b(r,i,n,d)}}])}else s?c.dom.toaster(M.util.get_string("efb-form-setting-saved","local_edwiserform"),3e3):b(r,i,n,a)}),e("#efb-form-title").keyup(function(){var t=e(this).val(),i=""==t;e(this).parent().toggleClass("has-danger",i),e("#id_title").val(t),_(t)}).change(function(){o()}),e("#id_title").keyup(function(){var t=e(this).val();e("#id_title").val(t),_(t)}).change(function(){var t=e(this).val();e("#efb-form-title").val(t),o()}),e("#id_type").change(function(){e(".efb-forms-template").removeClass("active");var t=e(this).val();e("#efb-forms-template-"+t).addClass("active"),e("#id_registration-enabled").prop("checked",!0)}),e(".efb-forms-template.pro").click(function(){var t=e(this).find(".efb-forms-template-name").text(),i=e(this).find(".efb-forms-template-details .desc").text();c.dom.proWarning({type:t,message:i})}),e(".efb-forms-template-select").click(function(i){var n=this;o();var r=function(){var i=e(n).data("template");e(n).parents(".efb-forms-template-overlay").addClass("loading"),t.call([{methodname:"edwiserform_get_template",args:{name:i}}])[0].done(function(t){e(n).parents(".efb-forms-template-overlay").removeClass("loading"),1!=t.status?c.dom.alert("warning",t.msg,function(){w(i,t.definition)}):w(i,t.definition)}).fail(function(t){e(n).parents(".efb-forms-template-overlay").removeClass("loading"),c.dom.alert("danger",t.message)})};e(".efb-forms-template.active").length&&!v()?c.dom.multiActions("warning",M.util.get_string("attention","local_edwiserform"),M.util.get_string("efb-template-change-warning","local_edwiserform"),[{title:M.util.get_string("proceed","local_edwiserform"),type:"warning",action:r},{title:M.util.get_string("cancel","local_edwiserform"),type:"success"}]):r()}),o()})}}});