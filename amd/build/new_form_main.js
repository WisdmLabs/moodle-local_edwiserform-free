"use strict";define(["jquery","core/ajax","core/notification","core/templates","local_edwiserform/efb_form_basic_settings","local_edwiserform/formbuilder","local_edwiserform/fastsearch","local_edwiserform/fastselect"],function(e,t,i,n){var o,s,r,a={FORMTYPE:"#id_type",COMPONENT:"local_edwiserform",EVENT:"#id_events",EVENT_LIST:".efb-event-list",FORM_STYLE:".efb-form-style",RENDER_FORM:".render-form",PANEL:".efb-panel-btn",TEMPLATE_OVERLAY:".efb-forms-template-overlay",TITLE:"#id_title",ACTIVE:"active",FORM_TITLE:"#efb-form-title"},l=document.querySelector(".build-form"),f=document.querySelector(a.RENDER_FORM),c=!1,d=null,m={container:l,svgSprite:M.cfg.wwwroot+"/local/edwiserform/pix/formeo-sprite.svg",localStorage:!1},u={GET_TEMPLATE:function(e){return t.call([{methodname:"edwiserform_get_template",args:{name:e}}])[0]},GET_EVENT_SETTINGS:function(e,i){return t.call([{methodname:"edwiserform_get_event_settings",args:{event:e,id:i}}])[0]},CREATE_NEW_FORM:function(e,i){return t.call([{methodname:"edwiserform_create_new_form",args:{setting:e,formdef:i.toString()}}])[0]},UPDATE_FORM:function(e,i){return t.call([{methodname:"edwiserform_update_form_settings",args:{setting:e,formdef:i.toString()}}])[0]}};function g(){var t=p()&&h(!1)&&!_();return e("#efb-btn-save-form-settings").parents(".efb-editor-button").toggleClass("d-none",!t),e(".efb-form-save").toggleClass("d-none",!t),t}function p(){return e(".efb-forms-template.active").length>0}function v(t){e(a.PANEL).removeClass(a.ACTIVE),e("#efb-".concat(t)).addClass(a.ACTIVE),e(".efb-tabcontent").removeClass(a.ACTIVE),e("#efb-cont-".concat(t)).addClass(a.ACTIVE)}function h(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];settings=s();var i=e(".efb-panel-btn.active").attr("id"),n=""!=settings.title;if(!t)return n;if(n)e(".efb-form-title-container").removeClass("has-danger"),e(a.TITLE).parents(".fitem").removeClass("has-danger");else{switch(i){case"efb-form-setup":case"efb-form-builder":case"efb-form-preview":v("form-settings");case"efb-form-settings":e(a.TITLE).parents(".fitem").addClass("has-danger")}r.dom.toaster(M.util.get_string("lbl-title-warning",a.COMPONENT),3e3)}return n}m.resetForm=function(){r.dom.loading();var t=e(a.FORMTYPE).val();u.GET_TEMPLATE(t).done(function(e){if(r.dom.loadingClose(),1==e.status)return m.container=l,void(r=new Formeo(m,e.definition))}).fail(function(e){r.dom.loadingClose(),i.exception(e)})},m.get_pro_demo_url=function(e){return videotypes.hasOwnProperty(e)?videotypes[e]:videotypes.default},s=function(){var t=e(a.FORMTYPE).val();return{title:e("#id_title").val(),description:e("#id_description").val(),type:t,notifi_email:e("#id_notifi_email").val(),message:e("#id_confirmation_msg").val(),draftitemid:e('[name="confirmation_msg[itemid]"]').val(),data_edit:e("#id_editdata").prop("checked")}},o=function(){return r.formData};var E={removeSelectedOption:function(t,i){if(t.value!=e(a.FORMTYPE).val()){var n=this.optionsCollection.removeSelected(t);n&&n.$item&&n.$item.removeClass(this.options.itemSelectedClass),i?i.remove():this.$el.find(selectorFromClass(this.options.choiceItemClass)+'[data-value="'+t.value+'"]').remove(),this.updateDomElements(),this.writeToInput(),"enrolment"==t.value&&e("#efb-event-enrolment").remove()}else r.dom.toaster(M.util.get_string("cannot-remove-event",a.COMPONENT,e(a.FORMTYPE).find("option:selected").html()),3e3)},setSelectedOption:function(t){if(!this.optionsCollection.isSelected(t.value)){this.optionsCollection.setSelected(t);var i=this.optionsCollection.findWhere(function(e){return e.value===t.value});if(this.isMultiple?this.$controls&&this.addChoiceItem(t):(this.fastsearch&&this.fastsearch.$resultItems.removeClass(this.options.itemSelectedClass),this.$toggleBtn&&this.$toggleBtn.text(t.text)),i&&i.$item.addClass(this.options.itemSelectedClass),this.updateDomElements(),"enrolment"==t.value){Formeo.dom.loading();var o=Array.from(Array(10).keys());o.push("..."),n.render("local_edwiserform/event_settings_container",{name:t.text,courses:o}).done(function(t,i){n.appendNodeContents(e(a.EVENT_LIST),t,i),Formeo.dom.loadingClose()})}}}};function _(){return formdef=JSON.parse(o()),0==Object.keys(formdef.fields).length}function b(e,t,i,n){("create"==e?u.CREATE_NEW_FORM(t,i):u.UPDATE_FORM(t,i)).done(n).fail(function(e){r.dom.alert("danger",e.message)})}function T(t){e(".efb-form-title").text(t),e(".efb-editor-action").toggleClass("efb-hide",t.length<0),t.length<0?e("#id_error_template_title").show():e("#id_error_template_title").hide()}function C(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e(a.FORMTYPE).val(t);var n=new CustomEvent("change",{target:e(a.FORMTYPE)[0]});e(a.FORMTYPE)[0].dispatchEvent(n),m.container=l,r=new Formeo(m,i),e("#efb-form-settings").trigger("click")}function w(){null==d&&(d=e(a.EVENT).hide().fastselect({callbacks:E})),e("#efb-settings-events").append('<div class="efb-event-list"></div>'),e(".efb-form-style-container .controls-toggle").click(function(){e(this).parents(".preview-form").toggleClass("show-styles"),e("#efb-cont-form-builder .formeo-controls").closest(".build-form").toggleClass("hidden-controls")}),e(a.FORM_STYLE).mouseenter(function(){e(".form-style-preview").attr("src",e(this).find("img").attr("src")).css("top",e(this).offset().top).show()}).mouseleave(a.FORM_STYLE,function(){e(".form-style-preview").attr("src","").hide()});var t=e("#id_allowsubmissionsfromdate_enabled").parent(),i=e(t).parent();t.detach().prependTo(i),t=e("#id_allowsubmissionstodate_enabled").parent(),i=e(t).parent(),t.detach().prependTo(i),e(".efb-settings-tab-list-item").click(function(){e(".efb-settings-tab-list-item").removeClass(a.ACTIVE),e(this).addClass(a.ACTIVE),e(".efb-settings-tab").removeClass(a.ACTIVE),e("#".concat(e(this).data("target"))).addClass(a.ACTIVE)}),e(document).on("formeoUpdated",function(e){g()}),e(document).on("controlsCollapsed",function(t){e(".efb-form-step-preview").toggleClass("collapsed",t.detail.collapsed)}),e(".efb-form-step").click(function(t){t.preventDefault();var i=e(this).data("id");e("#"+i).click()}),e(".efb-panel-btn").click(function(t){if(!p())return r.dom.toaster(M.util.get_string("select-template-warning",a.COMPONENT),3e3),v("form-setup"),void t.preventDefault();var i=e(this).attr("id");if("efb-form-setup"!=i&&"efb-form-settings"!=i&&!h())return 0;g();var n=e(this).data("panel");e("#efb-form-settings, #efb-form-builder, #efb-form-preview, #efb-form-setup").removeClass("active"),e("#efb-cont-form-settings, #efb-cont-form-builder, #efb-cont-form-preview, #efb-cont-form-setup").removeClass("active"),e(n).addClass("active"),e(this).addClass("active"),e(".efb-forms-panel-heading").text(e(this).data("panel-lbl")),"#efb-cont-form-preview"==n&&r.render(f)}),e("body").on("click","#efb-btn-save-form-settings",function(t){if(!p())return r.dom.toaster(M.util.get_string("select-template-warning",a.COMPONENT),3e3),v("form-setup"),void t.preventDefault();if(!h()||!r.validator.validate())return 0;var i=s(),n=o(),l=e("[name='id']").val(),f="create",d=function(t){1==t.status?(c=!0,window.onbeforeunload=null,r.dom.alert("success",t.msg,function(){r.reset(),e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}),setTimeout(function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")},4e3)):r.dom.alert("danger",t.msg)};if(l){var m=function(t){1==t.status?(window.onbeforeunload=null,r.dom.multiActions("success",M.util.get_string("success",a.COMPONENT),t.msg,[{title:M.util.get_string("heading-listforms",a.COMPONENT),type:"primary",action:function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}},{title:M.util.get_string("close",a.COMPONENT),type:"default"}])):r.dom.alert("danger",t.msg)};r.dom.multiActions("warning",M.util.get_string("attention",a.COMPONENT),M.util.get_string("forms-update-confirm",a.COMPONENT),[{title:M.util.get_string("forms-update-create-new",a.COMPONENT),type:"primary",action:function(){b(f,i,n,d)}},{title:M.util.get_string("forms-update-overwrite-existing",a.COMPONENT),type:"warning",action:function(){f="update",i.id=l,b(f,i,n,m)}}])}else c?r.dom.toaster(M.util.get_string("form-setting-saved",a.COMPONENT),3e3):b(f,i,n,d)}),e(a.FORM_TITLE).keyup(function(){var t=e(this).val(),i=""==t;e(this).parent().toggleClass("has-danger",i),e("#id_title").val(t),T(t)}).change(function(){g()}),e("#id_title").keyup(function(){var t=e(this).val();e("#id_title").val(t),T(t)}).change(function(){var t=e(this).val();e(a.FORM_TITLE).val(t),g()}),e(a.FORMTYPE).change(function(){e(".efb-forms-template").removeClass("active");var t=e(this).val();e("#efb-forms-template-"+t).addClass("active"),e("#id_registration-enabled").prop("checked",!0)}),e(".efb-forms-template.pro").click(function(){r.dom.proWarning({type:e(this).find(".efb-forms-template-name").text(),video:e(this).data("template"),message:e(this).find(".efb-forms-template-details .desc").text()})}),e(".efb-forms-template-select").click(function(t){var i=this;g();var n=function(){var t=e(i).data("template");e(i).parents(a.TEMPLATE_OVERLAY).addClass("loading"),u.GET_TEMPLATE(t).done(function(n){e(i).parents(a.TEMPLATE_OVERLAY).removeClass("loading"),1!=n.status?r.dom.alert("warning",n.msg,function(){C(t,n.definition)}):C(t,n.definition)}).fail(function(t){e(i).parents(a.TEMPLATE_OVERLAY).removeClass("loading"),r.dom.alert("danger",t.message)})};e(".efb-forms-template.active").length&&!_()?r.dom.multiActions("warning",M.util.get_string("attention",a.COMPONENT),M.util.get_string("template-change-warning",a.COMPONENT),[{title:M.util.get_string("proceed",a.COMPONENT),type:"warning",action:n},{title:M.util.get_string("cancel",a.COMPONENT),type:"success"}]):n()}),e("body").on("click",".efb-event-label",function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;""!=e(this).next().html()&&function(t,i){if(e(t).parent(".efb-event").hasClass("collapsed")){i||e(".efb-event:not(.collapsed) h4").each(function(t,i){e(i).trigger("click",[!0])}),e(t).parent(".efb-event").removeClass("collapsed"),e(t).next().height("auto");var n=e(t).next()[0].clientHeight+"px";e(t).next().height("0px"),setTimeout(function(){e(t).next().height(n)},0)}else e(t).next().height("0px"),e(t).next()[0].addEventListener("transitionend",function(){e(t).parent(".efb-event").addClass("collapsed")},{once:!0})}(this,i)}),g()}return{init:function(t,i){m.sitekey=t,m.prourl=i,e(document).ready(function(t){"undefined"!=typeof formdefinition?r=new Formeo(m,formdefinition):(m.localStorage=!0,r=new Formeo(m)),w(),e("#id_type").closest(".fitem").hide(),e("#root-page-loading").hide(),e(".efb-form-builder-wrap").show()})}}});